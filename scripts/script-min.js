var extractor,interpreter,ui;window.onload=function(){extractor=new Extractor("#mainContent section li","#mainContent button"),interpreter=new Interpreter(settings.tarification),ui=new UI(document.body,src),settings.autoLaunch&&ui.launch(!1)};class Extractor{data=[];firstEntry=0;lastEntry=0;mutationObserver=new MutationObserver(this.extractData.bind(this));seeMoreBtn;skipNextTitle;state=0;constructor(e,t){this.domSrc=e,this.seeMoreBtn=t}checkPage(){var e=window.location.pathname.slice(0,3),t="/mentorship/dashboard/mentorship-sessions-history";return window.location.pathname.slice(3)===t||(ui.addMessage(`<a href="${e+t}"><h1>ce n'est pas la bonne page</h1>aller à la page historique</a>`),!1)}extractData(){window.scrollTo(0,document.body.scrollHeight);var s=document.querySelectorAll(this.domSrc);for(let e=this.currentItem,t=s.length;e<t;e++){if(s[e].innerText.length<=20){if(this.state++,2===this.state){this.mutationObserver.disconnect();var i=interpreter.pluriel(this.data.length);return ui.clear(),ui.addMessage(`l'extraction achevée : ${this.data.length} seance${i} planififée${i}`),void interpreter.readData()}if(1===this.state){ui.addMessage("l'extraction commence");continue}}1===this.state&&(this.currentItem=e,(i=this.newLine(s[e]))&&this.data.push(i))}var e=document.querySelectorAll(this.seeMoreBtn);const t=e[e.length-1];void 0!==t&&(ui.addMessage("nouvelle requête pour avoir plus de séances"),t.click())}async extractStudentFunding(t){try{const i=await fetch(t);let e=await i.text();var s=e.indexOf("mentorshipStudent__details");return e=e.slice(s,s+100),e=e.slice(e.indexOf("<p>")+4,e.indexOf("</p>")-1),e=e.replace(/\n/g,"").trim(),e}catch(e){throw e}}newLine(e){const t=e.querySelectorAll("div");return{date:t[3].innerText,eleve:t[4].innerText,link:t[4].querySelector("a").href,niveau:t[8]?parseInt(t[8].innerText):null,type:t[0].innerText,realise:t[0].querySelector("svg").getAttribute("data-name").slice(0,-4)}}startSearch(e){this.currentItem=1,this.skipNextTitle=e,this.state=e?0:1,this.mutationObserver.observe(document.querySelector("#mainContent"),{childList:!0,subtree:!0}),ui.addMessage("recherche du début du mois sélectionné"),this.extractData()}update(e){localStorage.setItem("eleves",JSON.stringify(e))}}class UI{DOM;constructor(e,t){console.clear(),console.log("src:",t),this.DOM=document.querySelector(".mentorTools resume"),null===this.DOM&&this.initInterface(e,t),this.addMessage(`<button onclick="ui.launch(false)"> extraire les données de ${this.getMonth(!1)}</button>`),this.addMessage(`<button onclick="ui.launch(true)"> extraire les données de ${this.getMonth(!0)}</button>`)}addMessage(e,t=!1){const s=document.createElement("div");if(s.innerHTML=e,this.DOM.appendChild(s),t)return s.dataset.content=">",s}clear(){this.DOM.innerText=""}close(){const e=document.querySelector(".mentorTools");e.parentNode.removeChild(e)}getMonth(e){const t=new Date;return e&&t.setMonth(t.getMonth()-1),t.toLocaleString("default",{month:"long"})}initInterface(e,t){const s=document.createElement("link");s.type="text/css",s.rel="stylesheet",s.href=t+"/css/style.css",document.head.appendChild(s);const i=document.createElement("div");e.appendChild(i),i.className="mentorTools",i.innerHTML=`
    <svg onclick="ui.close()" focusable="false" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"></path>
    </svg>`,this.DOM=document.createElement("resume"),i.appendChild(this.DOM)}launch(e){this.clear(),extractor.checkPage()&&extractor.startSearch(e)}taskFinished(e,t){e.dataset.content=t?"✔":"X"}}class Interpreter{constructor(e){this.tarification=e,this.reset()}reset(){this.annulees=0,this.eleves={},this.elevesAutofinances=[],this.forfaits=0,this.joursTravailles=[],this.manuallyDefineFunding=[],this.nSeances=0,this.noShows=0,this.seances={},this.soutenances=0,this.temps=0,this.total=0}async readData(){this.reset();var e={eleves:JSON.parse(localStorage.getItem("eleves")),seances:extractor.data};this.eleves=null===e.eleves?{}:e.eleves;try{for(const t of e.seances){if(!t.realise)return;"Canceled"!==t.realise?(this.nSeances++,this.ajouteJourTravaille(t.date),await this.definirFinancement(t),this.temps+="Auto-financé"===t.financement?.5:1,this.definirTarif(t),this.addToCategory(t)):this.annulees++}if(0<this.manuallyDefineFunding.length)return ui.clear(),this.manuallyDefineFunding.forEach(e=>{ui.addMessage(`${e} : <select id="${e}"><option value="Auto-financé">Auto-financé</option><option value="Financé par un tiers">Financé par un tiers</option></select>`)}),void ui.addMessage('<button onclick="interpreter.readData()">je valide les changements</button>');this.elevesAutofinances=[...new Set(this.elevesAutofinances)],this.forfaits=this.elevesAutofinances.length,this.montantForfait=this.forfaits*this.tarification.forfait,this.temps+=this.forfaits,this.showResults()}catch(e){ui.addMessage("<i>erreur : </i>"+e.stack)}}showResults(){var e=this.total+this.montantForfait;const t=[];var s=extractor.data.length,i=this.pluriel(s);ui.clear(),ui.addMessage(`<span>${s}</span> x seance${i} planififée${i}<br>. . . . . . . . . . . . . . . . . . .`);for(const a of Object.keys(this.seances))t.push(a);t.sort(),t.forEach(e=>{ui.addMessage(`<span>${this.seances[e].length}</span> x ${e}`)}),i=this.pluriel(this.nSeances),ui.addMessage(`<span>${this.nSeances}</span> séance${i} facturée${i} dont ${this.noShows} no show${this.pluriel(this.noShows)} : ${this.total} €HT`),i=this.pluriel(this.forfaits),ui.addMessage(`<span>${this.forfaits}</span> x forfait${i} auto-financé : ${this.montantForfait} €HT`),ui.addMessage(`temps passé : ${this.temps} heure${this.pluriel(this.temps)}`),ui.addMessage("taux horaire "+Math.round(e/this.temps*100)/100+" €HT"),ui.addMessage("facturation : "+e+" €HT"),ui.addMessage("salaire : "+this.calculSalaire(e)+"€"),this.previsionnelSalaire()}pluriel(e){return 1<e?"s":""}apostrophe(e){return-1===["A","E","I","O","U","Y"].indexOf(e.slice(0,1))?"e ":"'"}addToCategory(e){var t="StudentAbsent"===e.realise?" no show":"",t=e.financement+" | niveau "+e.niveau+t;void 0===this.seances[t]&&(this.seances[t]=[]),this.seances[t].push(e)}async definirFinancement(e){if("Soutenance"===e.type)return this.soutenances++,void(e.financement="Soutenance");try{e.financement=await this.statutEleve(e.eleve,e.link),delete e.link}catch(e){throw e}}definirTarif(e){e.tarif=this.tarification["niveau"+e.niveau],"Auto-financé"===e.financement&&(this.elevesAutofinances.push(e.eleve),e.tarif=e.tarif/2),"StudentAbsent"===e.realise&&(e.tarif=e.tarif/2,this.noShows++),this.total+=e.tarif}calculSalaire(e){return e-Math.round(e*this.tarification.tauxCotisation)}async statutEleve(e,t){if(void 0===this.eleves[e])try{var s=ui.addMessage("récupère le financement d"+this.apostrophe(e)+e,!0);this.eleves[e]=await extractor.extractStudentFunding(t),"Auto-financé"===this.eleves[e]||"Financé par un tiers"===this.eleves[e]?(extractor.update(this.eleves),ui.taskFinished(s,!0)):(this.manuallyDefineFunding.push(e),ui.taskFinished(s,!1))}catch(e){throw e}return this.eleves[e]}ajouteJourTravaille(e){e=e.split(",")[0];-1===this.joursTravailles.indexOf(e)&&this.joursTravailles.push(e)}previsionnelSalaire(){var e=(new Date).getFullYear(),t=(new Date).getMonth(),s=new Intl.DateTimeFormat("fr-FR",{month:"long"}).format(new Date);const i=this.joursTravailles[this.joursTravailles.length-1];-1!==i.indexOf(s)&&parseInt(i.split(" ")[2])===e&&(s=new Date(t,e,0).getDate(),(s=this.getOpenedDays(e,t,s))!==(t=this.getOpenedDays(e,t,(new Date).getDate()))&&(s=(this.total-this.tarification.forfait)/t*s+this.tarification.forfait,ui.addMessage(`salaire prévisionnel : ${this.calculSalaire(s).toFixed(2)} €`)))}getOpenedDays(t,s,i){let a=0;for(let e=0;e<i;e++)new Date(t,s,e).getDay()<5&&a++;return a}}